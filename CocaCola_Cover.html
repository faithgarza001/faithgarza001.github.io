<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coca-Cola 3D Experience</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Open+Sans:wght@400;600;700&family=Poppins:wght@300;400;600;700&display=swap');
    
    body {
      margin: 0;
      overflow: hidden;
      background: radial-gradient(circle at center, #1a0000, #330000, #000000);
      color: #fff;
      font-family: 'Open Sans', sans-serif;
    }
    
    .ui-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 100;
    }
    
    .ui-element {
      pointer-events: auto;
    }
    
    .coca-cola-logo {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Bebas Neue', sans-serif;
      font-size: 3rem;
      font-weight: 400;
      color: #ff0000;
      text-shadow: 
        0 0 10px #ff0000,
        0 0 20px #ff0000,
        0 0 30px #ff0000,
        2px 2px 0 #cc0000,
        4px 4px 0 #990000;
      letter-spacing: 0.1em;
      animation: logoGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes logoGlow {
      from { 
        text-shadow: 
          0 0 10px #ff0000,
          0 0 20px #ff0000,
          0 0 30px #ff0000,
          2px 2px 0 #cc0000,
          4px 4px 0 #990000;
      }
      to { 
        text-shadow: 
          0 0 15px #ff0000,
          0 0 30px #ff0000,
          0 0 45px #ff0000,
          2px 2px 0 #cc0000,
          4px 4px 0 #990000;
      }
    }
    
    .control-panel {
      position: absolute;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: center;
      z-index: 10;
    }
    
    .coke-btn {
      padding: 12px 24px;
      background: linear-gradient(45deg, #ff0000, #cc0000);
      border: 2px solid #ffffff;
      color: white;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 700;
      font-family: 'Open Sans', sans-serif;
      transition: all 0.3s ease;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
    }
    
    .coke-btn:hover {
      background: linear-gradient(45deg, #ff3333, #ff0000);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
    }
    
    .coke-btn:active {
      transform: translateY(0);
    }
    
    #audio-prompt {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(45deg, #ff0000, #cc0000);
      padding: 30px 50px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1.4rem;
      font-weight: 700;
      z-index: 1000;
      transition: all 0.5s ease;
      border: 3px solid #ffffff;
      text-align: center;
      box-shadow: 0 10px 30px rgba(255, 0, 0, 0.4);
    }
    
    #audio-prompt:hover {
      background: linear-gradient(45deg, #ff3333, #ff0000);
      transform: translate(-50%, -50%) scale(1.05);
      box-shadow: 0 15px 40px rgba(255, 0, 0, 0.6);
    }
    
    .stats-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 15px;
      font-family: 'Open Sans', sans-serif;
      font-size: 0.9rem;
      border: 2px solid #ff0000;
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 15px rgba(255, 0, 0, 0.2);
    }
    
    .stat-value {
      color: #ff0000;
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .tagline {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.8rem;
      font-weight: 700;
      color: #ffffff;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
      text-align: center;
      animation: taglinePulse 3s ease-in-out infinite;
    }
    
    @keyframes taglinePulse {
      0%, 100% { opacity: 0.9; transform: translateX(-50%) scale(1); }
      50% { opacity: 1; transform: translateX(-50%) scale(1.02); }
    }
    
    .info-text {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: #cccccc;
      font-size: 1rem;
      font-weight: 400;
    }

    /* ===== Clean UI mode overrides (non-destructive) ===== */
    body.clean-ui .ui-overlay { display:flex; flex-direction:column; justify-content:space-between; align-items:center; padding:2rem; }
    body.clean-ui .coca-cola-logo, body.clean-ui .control-panel, body.clean-ui .tagline, body.clean-ui .info-text, body.clean-ui #audio-prompt { position:static; left:auto; top:auto; bottom:auto; transform:none; }
    body.clean-ui .coca-cola-logo { order:1; font-size:3.6rem; font-family:'Poppins',sans-serif; font-weight:700; letter-spacing:.08em; text-shadow:0 0 10px #e60023,0 0 22px #e60023; }
    body.clean-ui #audio-prompt { order:2; margin-top:1rem; }
    body.clean-ui .tagline { order:3; animation:none; margin-top:auto; font-family:'Poppins',sans-serif; font-size:2rem; }
    body.clean-ui .control-panel { order:4; background:rgba(255,255,255,0.1); backdrop-filter:blur(14px) saturate(180%); border:1px solid rgba(255,255,255,0.15); border-radius:22px; padding:1rem 1.25rem; gap:.75rem; }
    body.clean-ui .info-text { order:5; font-size:.85rem; opacity:.85; margin-top:.75rem; margin-bottom:.5rem; }
    body.clean-ui .coke-btn { border:none; padding:10px 18px; border-radius:40px; font-family:'Poppins',sans-serif; font-weight:600; font-size:.7rem; letter-spacing:.12em; background:linear-gradient(135deg,#e60023,#a30018); box-shadow:0 4px 14px rgba(230,0,35,.35); }
    body.clean-ui .coke-btn:hover { background:linear-gradient(135deg,#ff3333,#e60023); transform:translateY(-3px); box-shadow:0 8px 24px rgba(230,0,35,.5); }
    body.clean-ui .coke-btn:active { transform:translateY(0); box-shadow:0 2px 8px rgba(230,0,35,.35); }
    body.clean-ui #audio-prompt { background:linear-gradient(45deg,#e60023,#a30018); box-shadow:0 10px 30px rgba(230,0,35,.4); }
    body.clean-ui .stats-panel { top:1.2rem; right:1.2rem; padding:14px 20px; border-radius:14px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.55); }
    body.clean-ui .fps-counter { top:1.2rem; left:1.2rem; }
    @media (max-width: 768px){
      body.clean-ui .coca-cola-logo { font-size:2.6rem; }
      body.clean-ui .control-panel { justify-content:center; }
    }
    
    .fps-counter {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #00ff00;
      font-family: monospace;
      font-size: 1rem;
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 12px;
      border-radius: 8px;
    }

    .snow-particle {
      position: absolute;
      color: white;
      font-size: 20px;
      animation: snowfall 10s linear infinite;
      pointer-events: none;
      z-index: 5;
    }

    @keyframes snowfall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* ===== Card Mode (lightweight embedded variant) ===== */
    body.card-mode { overflow:hidden; }
    body.card-mode .stats-panel,
    body.card-mode .info-text,
    body.card-mode #audio-prompt,
    body.card-mode .fps-counter { display:none !important; }
    body.card-mode .coca-cola-logo { top:8px; font-size:1.4rem; animation:none; text-shadow:0 0 8px #ff0000; }
    body.card-mode .tagline { bottom:12px; font-size:1rem; animation:none; opacity:.85; }
    body.card-mode .ui-overlay { pointer-events:auto; }
    body.card-mode .control-panel { pointer-events:auto; position:absolute; bottom:6px; left:50%; transform:translateX(-50%); gap:6px; padding:4px 6px; background:rgba(0,0,0,0.35); border-radius:16px; backdrop-filter:blur(6px); }
    body.card-mode .coke-btn { padding:6px 10px; font-size:0.55rem; letter-spacing:.08em; border-width:1px; box-shadow:0 2px 6px rgba(255,0,0,.3); }
    body.card-mode #fizz-explosion,
    body.card-mode #ice-shower,
    body.card-mode #bubble-storm,
    body.card-mode #cola-wave { display:none !important; }
    body.card-mode canvas { pointer-events:none; }
    /* Slightly dim background for small footprint */
    body.card-mode { background: radial-gradient(circle at center, #120000, #200000, #000000); }
  /* When requesting full controls inside card embed */
  body.card-mode.card-show-all #fizz-explosion,
  body.card-mode.card-show-all #ice-shower,
  body.card-mode.card-show-all #bubble-storm,
  body.card-mode.card-show-all #cola-wave { display:inline-block !important; }
  body.card-mode.card-show-all .control-panel { bottom:4px; }
  body.card-mode.card-show-all .coke-btn { font-size:0.6rem; }
  </style>
</head>
<body>
  <div class="ui-overlay">
    <div id="audio-prompt" class="ui-element">
      üéµ Click to Experience the Magic<br>
      <span style="font-size: 1rem; font-weight: 400;">with immersive sound</span>
    </div>
    
    <div class="coca-cola-logo">Coca-Cola</div>
    
    <div class="control-panel">
      <button id="fizz-explosion" class="coke-btn ui-element">üí• Fizz Explosion</button>
      <button id="ice-shower" class="coke-btn ui-element">‚ùÑÔ∏è Ice Shower</button>
      <button id="bubble-storm" class="coke-btn ui-element">ü´ß Bubble Storm</button>
      <button id="cola-wave" class="coke-btn ui-element">üåä Cola Wave</button>
      <button id="refresh-mode" class="coke-btn ui-element">‚ú® Refresh Mode</button>
    </div>
    
    <div class="stats-panel ui-element">
      <div>Bubbles: <span class="stat-value" id="bubble-count">0</span></div>
      <div>Ice Cubes: <span class="stat-value" id="ice-count">0</span></div>
      <div>Effects: <span class="stat-value" id="effect-count">0</span></div>
      <div>Refreshment: <span class="stat-value" id="refresh-level">100%</span></div>
    </div>
    
    <div class="fps-counter ui-element" id="fps-counter">FPS: 60</div>
    
    <div class="tagline">Taste The Feeling</div>
    
    <div class="info-text">
      üñ±Ô∏è Drag to explore ‚Ä¢ üì± Touch to interact ‚Ä¢ üéÆ Use controls for amazing effects
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Enable clean UI mode if '?clean=0' not explicitly set
      try {
        const p = new URLSearchParams(location.search);
        const forceOff = p.get('clean') === '0';
        const modeParam = p.get('mode');
        const cardMode = modeParam === 'card';
        const controlsAll = p.get('controls') === 'all';
        if(!forceOff) document.body.classList.add('clean-ui');
        if(cardMode) document.body.classList.add('card-mode');
        if(cardMode && controlsAll) document.body.classList.add('card-show-all');
        window.__CARD_MODE__ = cardMode; // expose for debugging
      } catch(e) { /* noop */ }
      let scene, camera, renderer, bottle, ambientLight, pointLight, spotLight;
      const bubbles = [], iceParticles = [], colaDrops = [], sparkles = [];
      let isDragging = false, previousMousePosition = { x: 0, y: 0 };
      let audioContextStarted = false, refreshMode = false;
      let mouseX = 0, mouseY = 0;
      const DAMPING = 0.06;
      let frameCount = 0, lastTime = performance.now();
      const cardMode = document.body.classList.contains('card-mode');

      // UI Elements
      const fizzBtn = document.getElementById('fizz-explosion');
      const iceBtn = document.getElementById('ice-shower');
      const bubbleBtn = document.getElementById('bubble-storm');
      const waveBtn = document.getElementById('cola-wave');
      const refreshBtn = document.getElementById('refresh-mode');
      const audioPrompt = document.getElementById('audio-prompt');
      const fpsCounter = document.getElementById('fps-counter');
      // Add a Full button in card mode
      if(cardMode) {
        const fullBtn = document.createElement('button');
        fullBtn.id = 'open-full';
        fullBtn.textContent = '‚Üó Full';
        fullBtn.className = 'coke-btn ui-element';
        fullBtn.addEventListener('click', (e)=>{ e.stopPropagation(); window.open('coca_cola_3d_experience.html','_blank','width=1400,height=900'); });
        const panel = document.querySelector('.control-panel');
        if(panel) panel.appendChild(fullBtn);
      }

      // Enhanced Coca-Cola themed audio
      const reverb = new Tone.Reverb(3).toDestination();
      const delay = new Tone.PingPongDelay("8n", 0.25).connect(reverb);
      
      const fizzSynth = new Tone.NoiseSynth({
        noise: { type: 'white' },
        envelope: { attack: 0.02, decay: 0.8, sustain: 0.1, release: 1.2 },
      }).connect(delay);
      
      const popSynth = new Tone.Synth({
        oscillator: { type: 'sine' },
        envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 },
      }).connect(reverb);
      
      const iceSynth = new Tone.MetalSynth({
        frequency: 400,
        envelope: { attack: 0.001, decay: 0.4, release: 0.8 },
        harmonicity: 8,
        modulationIndex: 2,
        resonance: 4000,
        octaves: 1.5
      }).connect(reverb);

      const refreshSynth = new Tone.Synth({
        oscillator: { type: 'triangle' },
        envelope: { attack: 0.5, decay: 0.3, sustain: 0.4, release: 1.0 },
      }).connect(reverb);

      // Audio initialization (suppressed in card mode for lightweight embed)
      if(!cardMode) {
        document.addEventListener('click', () => {
          if (!audioContextStarted) {
            Tone.start().then(() => {
              console.log("Coca-Cola audio experience activated!");
              audioContextStarted = true;
              gsap.to(audioPrompt, { 
                opacity: 0, 
                scale: 0.3, 
                rotation: 360,
                duration: 1.0, 
                ease: "back.in(2)",
                onComplete: () => {
                  audioPrompt.style.display = 'none';
                  startAmbientExperience();
                }
              });
            }).catch(e => console.error("Audio initialization failed:", e));
          }
        }, { once: true });
      } else {
        // hide prompt immediately in card mode
        audioPrompt.style.display = 'none';
      }

      function startAmbientExperience() {
        // Play refreshing ambient sounds
        const playRefreshSound = () => {
          if (audioContextStarted) {
            refreshSynth.triggerAttackRelease(['C4', 'E4', 'G4'][Math.floor(Math.random() * 3)], "1n");
            setTimeout(playRefreshSound, Math.random() * 8000 + 4000);
          }
        };
        setTimeout(playRefreshSound, 2000);
        
        // Start gentle fizzing
        setTimeout(() => {
          if (audioContextStarted) {
            fizzSynth.triggerAttackRelease("2n");
          }
        }, 1000);
      }

      function init() {
        // Enhanced scene setup
        scene = new THREE.Scene();
        scene.fog = new THREE.Fog(0x220000, 10, 30);
        
        // Dynamic Coca-Cola themed background
        const bgGeometry = new THREE.SphereGeometry(50, 32, 32);
        const bgMaterial = new THREE.ShaderMaterial({
          uniforms: {
            time: { value: 0 },
            refreshMode: { value: 0.0 }
          },
          vertexShader: `
            varying vec2 vUv;
            varying vec3 vPosition;
            void main() {
              vUv = uv;
              vPosition = position;
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,
          fragmentShader: `
            uniform float time;
            uniform float refreshMode;
            varying vec2 vUv;
            varying vec3 vPosition;
            void main() {
              vec3 cokeRed = vec3(0.8, 0.0, 0.0);
              vec3 deepRed = vec3(0.3, 0.0, 0.0);
              vec3 refreshBlue = vec3(0.0, 0.3, 0.8);
              
              float noise = sin(vPosition.x * 0.1 + time * 0.5) * sin(vPosition.y * 0.1 + time * 0.3) * 0.3 + 0.7;
              vec3 baseColor = mix(mix(deepRed, cokeRed, vUv.y), refreshBlue, refreshMode * 0.3);
              vec3 finalColor = baseColor * noise;
              
              gl_FragColor = vec4(finalColor, 1.0);
            }
          `,
          side: THREE.BackSide
        });
        const bgMesh = new THREE.Mesh(bgGeometry, bgMaterial);
        scene.add(bgMesh);

        // Camera setup
  camera = new THREE.PerspectiveCamera(cardMode ? 60 : 75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.set(0, cardMode ? 1.6 : 2, cardMode ? 5.5 : 8);
  camera.updateProjectionMatrix();

        // Enhanced renderer
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.3;
        document.body.appendChild(renderer.domElement);

        // Coca-Cola themed lighting
        ambientLight = new THREE.AmbientLight(0x441111, 0.6);
        scene.add(ambientLight);
        
        pointLight = new THREE.PointLight(0xff3333, 3, 15);
        pointLight.position.set(4, 6, 4);
        pointLight.castShadow = true;
        scene.add(pointLight);
        
        spotLight = new THREE.SpotLight(0xffffff, 2);
        spotLight.position.set(0, 10, 0);
        spotLight.castShadow = true;
        scene.add(spotLight);

        // Animated accent lights
        const redRimLight = new THREE.PointLight(0xff0000, 2, 10);
        scene.add(redRimLight);
        gsap.to(redRimLight.position, {
          x: -6, y: 3, z: 2,
          duration: 4, yoyo: true, repeat: -1, ease: "sine.inOut"
        });

        const whiteAccentLight = new THREE.PointLight(0xffffff, 1.5, 8);
        whiteAccentLight.position.set(0, -2, 6);
        scene.add(whiteAccentLight);

        createCocaColaBottle();
        createEnvironmentalEffects();
        setupEventListeners();

        // Start bubble system
        const bubbleInterval = cardMode ? 300 : 120;
        const sparkleInterval = cardMode ? 600 : 200;
        setInterval(createBubble, bubbleInterval);
        setInterval(createSparkle, sparkleInterval);
        
        animate();
      }

      function createCocaColaBottle() {
        const bottleGroup = new THREE.Group();

        // Create bottle texture
        const canvas = document.createElement('canvas');
        canvas.width = 1024;
        canvas.height = 2048;
        const ctx = canvas.getContext('2d');
        
        // Coca-Cola red gradient
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#ff4444');
        gradient.addColorStop(0.1, '#ff0000');
        gradient.addColorStop(0.3, '#cc0000');
        gradient.addColorStop(0.7, '#990000');
        gradient.addColorStop(1, '#660000');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Coca-Cola logo
        ctx.font = 'bold 140px serif';
        ctx.fillStyle = '#ffffff';
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 8;
        ctx.textAlign = 'center';
        
        // Script-like Coca-Cola text
        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2 - 200);
        ctx.rotate(-0.1);
        ctx.strokeText('Coca-Cola', 0, 0);
        ctx.fillText('Coca-Cola', 0, 0);
        ctx.restore();
        
        // Add classic Coca-Cola wave
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 12;
        ctx.beginPath();
        for(let i = 0; i < canvas.width; i += 2) {
          const y = canvas.height/2 + 100 + Math.sin(i * 0.02) * 30;
          if(i === 0) ctx.moveTo(i, y);
          else ctx.lineTo(i, y);
        }
        ctx.stroke();

        const bottleTexture = new THREE.CanvasTexture(canvas);

        // Classic Coca-Cola bottle shape
        const bottleShape = new THREE.Shape();
        bottleShape.moveTo(0, -3);
        bottleShape.lineTo(0.8, -3);
        bottleShape.lineTo(0.9, -2);
        bottleShape.lineTo(0.6, 0);
        bottleShape.lineTo(0.7, 1);
        bottleShape.lineTo(0.5, 2);
        bottleShape.lineTo(0.4, 2.5);
        bottleShape.lineTo(0.3, 3);
        bottleShape.lineTo(0, 3);

        const bottleGeometry = new THREE.LatheGeometry(
          bottleShape.getPoints(50).map(p => new THREE.Vector2(p.x, p.y)), 64
        );
        
        const bottleMaterial = new THREE.MeshStandardMaterial({
          map: bottleTexture,
          roughness: 0.2,
          metalness: 0.1,
          transparent: true,
          opacity: 0.9
        });
        
        const bottleMesh = new THREE.Mesh(bottleGeometry, bottleMaterial);
        bottleMesh.castShadow = true;
        bottleMesh.receiveShadow = true;

        // Bottle cap
        const capGeometry = new THREE.CylinderGeometry(0.35, 0.35, 0.3, 32);
        const capMaterial = new THREE.MeshStandardMaterial({
          color: 0xcc0000,
          roughness: 0.3,
          metalness: 0.8
        });
        const bottleCap = new THREE.Mesh(capGeometry, capMaterial);
        bottleCap.position.y = 3.15;
        bottleCap.castShadow = true;

        bottleGroup.add(bottleMesh, bottleCap);
        bottle = bottleGroup;
        scene.add(bottle);

        // Bottle animations
        gsap.to(bottle.rotation, { y: Math.PI * 2, duration: 25, repeat: -1, ease: "none" });
        gsap.to(bottle.position, { 
          y: 1.2, 
          duration: 5, 
          ease: "sine.inOut", 
          yoyo: true, 
          repeat: -1 
        });
        gsap.to(bottle.rotation, {
          z: 0.05,
          duration: 8,
          ease: "sine.inOut",
          yoyo: true,
          repeat: -1
        });
      }

      function createEnvironmentalEffects() {
        // Floating sparkles
        const sparkleCount = cardMode ? 35 : 100;
        for(let i = 0; i < sparkleCount; i++) {
          const sparkle = createEnvironmentalSparkle();
          sparkles.push(sparkle);
        }
      }

      function createEnvironmentalSparkle() {
        const sparkleGeometry = new THREE.SphereGeometry(Math.random() * 0.03 + 0.01, 8, 8);
        const sparkleColor = Math.random() > 0.7 ? 0xffffff : 0xff6666;
        const sparkleMaterial = new THREE.MeshBasicMaterial({
          color: sparkleColor,
          transparent: true,
          opacity: Math.random() * 0.6 + 0.2
        });
        const sparkle = new THREE.Mesh(sparkleGeometry, sparkleMaterial);
        
        sparkle.position.set(
          (Math.random() - 0.5) * 25,
          (Math.random() - 0.5) * 25,
          (Math.random() - 0.5) * 25
        );
        
        scene.add(sparkle);
        
        // Animate sparkles
        gsap.to(sparkle.position, {
          x: sparkle.position.x + (Math.random() - 0.5) * 15,
          y: sparkle.position.y + (Math.random() - 0.5) * 15,
          z: sparkle.position.z + (Math.random() - 0.5) * 15,
          duration: Math.random() * 30 + 15,
          repeat: -1,
          yoyo: true,
          ease: "sine.inOut"
        });
        
        gsap.to(sparkle.material, {
          opacity: Math.random() * 0.8 + 0.1,
          duration: Math.random() * 3 + 1,
          repeat: -1,
          yoyo: true,
          ease: "sine.inOut"
        });
        
        return sparkle;
      }

      function createBubble() {
        const size = Math.random() * 0.1 + 0.03;
        const bubbleGeometry = new THREE.SphereGeometry(size, 16, 16);
        const bubbleMaterial = new THREE.MeshStandardMaterial({
          color: refreshMode ? 0x66ccff : 0xffffff,
          transparent: true,
          opacity: 0.7,
          roughness: 0.1,
          metalness: 0.1
        });
        const bubble = new THREE.Mesh(bubbleGeometry, bubbleMaterial);
        
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * 0.5;
        bubble.position.set(
          Math.cos(angle) * radius,
          -2.5,
          Math.sin(angle) * radius
        );
        
        scene.add(bubble);
        bubbles.push(bubble);

        // Bubble sound
        if (audioContextStarted) {
          const frequency = 300 + size * 1000;
          popSynth.frequency.value = frequency;
          popSynth.triggerAttackRelease("32n", Tone.now() + Math.random() * 0.3);
        }

        // Bubble animation
        gsap.to(bubble.position, {
          y: 4 + Math.random() * 2,
          x: bubble.position.x + (Math.random() - 0.5) * 3,
          z: bubble.position.z + (Math.random() - 0.5) * 3,
          duration: Math.random() * 4 + 3,
          ease: "none",
          onComplete: () => {
            scene.remove(bubble);
            const index = bubbles.indexOf(bubble);
            if (index > -1) bubbles.splice(index, 1);
          }
        });

        // Bubble effects
        gsap.to(bubble.scale, {
          x: 1 + Math.random() * 0.4,
          y: 1 + Math.random() * 0.4,
          z: 1 + Math.random() * 0.4,
          duration: Math.random() * 2 + 1,
          repeat: -1,
          yoyo: true,
          ease: "sine.inOut"
        });
      }

      function createSparkle() {
        const sparkleGeometry = new THREE.SphereGeometry(0.02, 8, 8);
        const sparkleMaterial = new THREE.MeshBasicMaterial({
          color: Math.random() > 0.5 ? 0xffffff : 0xffff00,
          transparent: true,
          opacity: 0.8
        });
        const sparkle = new THREE.Mesh(sparkleGeometry, sparkleMaterial);
        
        sparkle.position.set(
          (Math.random() - 0.5) * 2,
          bottle.position.y + (Math.random() - 0.5) * 4,
          (Math.random() - 0.5) * 2
        );
        
        scene.add(sparkle);
        sparkles.push(sparkle);

        gsap.to(sparkle.position, {
          y: sparkle.position.y + Math.random() * 3 + 1,
          duration: Math.random() * 2 + 1,
          ease: "power2.out",
          onComplete: () => {
            scene.remove(sparkle);
            const index = sparkles.indexOf(sparkle);
            if (index > -1) sparkles.splice(index, 1);
          }
        });
      }

      function setupEventListeners() {
        // Window events
        window.addEventListener('resize', onWindowResize, false);
        window.addEventListener('mousedown', onMouseDown, false);
        window.addEventListener('mousemove', onMouseMove, false);
        window.addEventListener('mouseup', onMouseUp, false);

        // Button events
        fizzBtn.addEventListener('click', createFizzExplosion);
        iceBtn.addEventListener('click', createIceShower);
        bubbleBtn.addEventListener('click', createBubbleStorm);
        waveBtn.addEventListener('click', createColaWave);
        refreshBtn.addEventListener('click', toggleRefreshMode);
      }

      function createFizzExplosion() {
        // Reduced intensity in card mode
        if (audioContextStarted) {
          fizzSynth.triggerAttackRelease("2n", Tone.now());
        }

        // Screen shake
        gsap.to(camera.position, {
          x: camera.position.x + (Math.random() - 0.5) * 0.3,
          y: camera.position.y + (Math.random() - 0.5) * 0.3,
          duration: 0.1,
          yoyo: true,
          repeat: 3
        });

        // Create fizz particles
        const fizzCount = cardMode ? 150 : 500;
        for (let i = 0; i < fizzCount; i++) {
          setTimeout(() => createBubble(), i * (cardMode ? 4 : 2));
        }

        // Light flash
        gsap.to(pointLight, {
          intensity: 6,
          duration: 0.2,
          yoyo: true,
          repeat: 1
        });
      }

      function createIceShower() {
        // Reduced intensity for card mode
        if (audioContextStarted) {
          iceSynth.triggerAttackRelease("8n", Tone.now());
        }
        const iceCount = cardMode ? 50 : 200;
        for (let i = 0; i < iceCount; i++) {
          const ice = createIceCube();
          iceParticles.push(ice);
        }
      }

      function createIceCube() {
        const iceGeometry = new THREE.BoxGeometry(
          Math.random() * 0.15 + 0.05,
          Math.random() * 0.15 + 0.05,
          Math.random() * 0.15 + 0.05
        );
        const iceMaterial = new THREE.MeshStandardMaterial({
          color: 0xccffff,
          transparent: true,
          opacity: 0.8,
          roughness: 0.1,
          metalness: 0.2
        });
        const ice = new THREE.Mesh(iceGeometry, iceMaterial);
        
        ice.position.set(
          (Math.random() - 0.5) * 8,
          6 + Math.random() * 2,
          (Math.random() - 0.5) * 8
        );
        
        scene.add(ice);
        
        // Ice cube physics
        ice.velocity = {
          x: (Math.random() - 0.5) * 0.2,
          y: 0,
          z: (Math.random() - 0.5) * 0.2
        };
        
        gsap.to(ice.position, {
          y: -3,
          duration: Math.random() * 2 + 2,
          ease: "bounce.out",
          onComplete: () => {
            scene.remove(ice);
            const index = iceParticles.indexOf(ice);
            if (index > -1) iceParticles.splice(index, 1);
          }
        });
        
        gsap.to(ice.rotation, {
          x: Math.PI * 2,
          y: Math.PI * 2,
          z: Math.PI * 2,
          duration: Math.random() * 3 + 1,
          ease: "none"
        });
        
        return ice;
      }

      function createBubbleStorm() {
        if (audioContextStarted) {
          for(let i = 0; i < 5; i++) {
            setTimeout(() => {
              popSynth.frequency.value = 200 + Math.random() * 800;
              popSynth.triggerAttackRelease("16n");
            }, i * 100);
          }
        }
        // Create bubble tornado effect (reduced in card mode)
        const stormCount = cardMode ? 80 : 300;
        for (let i = 0; i < stormCount; i++) {
          setTimeout(() => {
            const bubble = createTornadoBubble(i);
            bubbles.push(bubble);
          }, i * (cardMode ? 18 : 10));
        }
      }

      function createTornadoBubble(index) {
        const size = Math.random() * 0.08 + 0.02;
        const bubbleGeometry = new THREE.SphereGeometry(size, 12, 12);
        const bubbleMaterial = new THREE.MeshStandardMaterial({
          color: new THREE.Color().setHSL((index * 0.01) % 1, 0.8, 0.9),
          transparent: true,
          opacity: 0.8
        });
        const bubble = new THREE.Mesh(bubbleGeometry, bubbleMaterial);
        
        const angle = (index * 0.1) % (Math.PI * 2);
        const radius = 0.5 + Math.sin(index * 0.05) * 0.3;
        bubble.position.set(
          Math.cos(angle) * radius,
          -2 + (index * 0.02),
          Math.sin(angle) * radius
        );
        
        scene.add(bubble);

        // Tornado spiral animation
        gsap.to(bubble.position, {
          y: 5,
          duration: 8,
          ease: "none",
          onComplete: () => {
            scene.remove(bubble);
            const bubbleIndex = bubbles.indexOf(bubble);
            if (bubbleIndex > -1) bubbles.splice(bubbleIndex, 1);
          }
        });

        gsap.to(bubble, {
          rotation: { x: Math.PI * 4, y: Math.PI * 4, z: Math.PI * 4 },
          duration: 8,
          ease: "none"
        });

        return bubble;
      }

      function createColaWave() {
        if (audioContextStarted) {
          fizzSynth.triggerAttackRelease("1n", Tone.now());
        }
        // Create wave of cola drops (reduced in card mode)
        const dropCount = cardMode ? 50 : 150;
        for (let i = 0; i < dropCount; i++) {
          setTimeout(() => {
            const drop = createColaDrop();
            colaDrops.push(drop);
          }, i * (cardMode ? 30 : 20));
        }

        // Camera wave effect
        gsap.to(camera.position, {
          z: camera.position.z + 2,
          duration: 1,
          yoyo: true,
          repeat: 1,
          ease: "sine.inOut"
        });
      }

      function createColaDrop() {
        const dropGeometry = new THREE.SphereGeometry(Math.random() * 0.06 + 0.02, 8, 8);
        const dropMaterial = new THREE.MeshStandardMaterial({
          color: new THREE.Color(0.4 + Math.random() * 0.2, 0, 0),
          transparent: true,
          opacity: 0.9,
          roughness: 0.8
        });
        const drop = new THREE.Mesh(dropGeometry, dropMaterial);
        
        drop.position.set(
          (Math.random() - 0.5) * 6,
          bottle.position.y + 2,
          (Math.random() - 0.5) * 6
        );
        
        scene.add(drop);

        // Drop physics
        gsap.to(drop.position, {
          y: -3,
          x: drop.position.x + (Math.random() - 0.5) * 2,
          z: drop.position.z + (Math.random() - 0.5) * 2,
          duration: Math.random() * 2 + 1.5,
          ease: "power2.in",
          onComplete: () => {
            scene.remove(drop);
            const index = colaDrops.indexOf(drop);
            if (index > -1) colaDrops.splice(index, 1);
          }
        });

        return drop;
      }

      function toggleRefreshMode() {
        refreshMode = !refreshMode;
        refreshBtn.textContent = refreshMode ? '‚≠ê Classic Mode' : '‚ú® Refresh Mode';

        // Change scene colors
        scene.children.forEach(child => {
          if (child.material && child.material.uniforms && child.material.uniforms.refreshMode) {
            gsap.to(child.material.uniforms.refreshMode, {
              value: refreshMode ? 1.0 : 0.0,
              duration: 2,
              ease: "power2.inOut"
            });
          }
        });

        // Update lighting
        if (refreshMode) {
          gsap.to(pointLight.color, { r: 0.3, g: 0.6, b: 1.0, duration: 2 });
          gsap.to(ambientLight.color, { r: 0.2, g: 0.4, b: 0.8, duration: 2 });
        } else {
          gsap.to(pointLight.color, { r: 1.0, g: 0.2, b: 0.2, duration: 2 });
          gsap.to(ambientLight.color, { r: 0.3, g: 0.1, b: 0.1, duration: 2 });
        }

        if (audioContextStarted) {
          refreshSynth.triggerAttackRelease(refreshMode ? "C5" : "C4", "1n");
        }
      }

      function updateStats() {
        document.getElementById('bubble-count').textContent = bubbles.length;
        document.getElementById('ice-count').textContent = iceParticles.length;
        document.getElementById('effect-count').textContent = 
          bubbles.length + iceParticles.length + colaDrops.length + sparkles.length;
        document.getElementById('refresh-level').textContent = 
          Math.max(0, 100 - Math.floor((bubbles.length + iceParticles.length) / 5)) + '%';
      }

      function animate() {
        requestAnimationFrame(animate);
        frameCount++;

        // FPS Counter
        const currentTime = performance.now();
        if (currentTime - lastTime >= 1000) {
          document.getElementById('fps-counter').textContent = `FPS: ${frameCount}`;
          frameCount = 0;
          lastTime = currentTime;
        }

        // Camera controls
        camera.position.x += (mouseX - camera.position.x) * DAMPING;
        camera.position.y += (-mouseY - camera.position.y) * DAMPING;
        camera.lookAt(bottle.position);

        // Update shader uniforms
        scene.children.forEach(child => {
          if (child.material && child.material.uniforms && child.material.uniforms.time) {
            child.material.uniforms.time.value = currentTime * 0.001;
          }
        });

        // Update particle physics
        iceParticles.forEach(ice => {
          if (ice.velocity) {
            ice.position.x += ice.velocity.x;
            ice.position.z += ice.velocity.z;
          }
        });

        updateStats();
        renderer.render(scene, camera);
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function onMouseDown(event) {
        isDragging = true;
        previousMousePosition = { x: event.clientX, y: event.clientY };
      }

      function onMouseMove(event) {
        if (!isDragging) return;
        const deltaMove = {
          x: event.clientX - previousMousePosition.x,
          y: event.clientY - previousMousePosition.y
        };

        const rotationSpeed = 0.008;
        mouseX += deltaMove.x * rotationSpeed;
        mouseY += deltaMove.y * rotationSpeed;

        previousMousePosition = { x: event.clientX, y: event.clientY };
      }

      function onMouseUp() {
        isDragging = false;
      }

      // Initialize the experience
      init();
    });
  </script>
</body>
</html>
          